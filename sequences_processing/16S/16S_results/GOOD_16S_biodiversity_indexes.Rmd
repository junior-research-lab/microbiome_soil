---
title: "GOOD_16S_biodiversity_indexes"
author: "group 2 microbiome"
date: "17/6/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(purrr)
library(openxlsx)
library(tidyverse)
library(vegan)
library(readr)
library(readxl)
library(plyr)
library(utils)
library(estimatr)
library(ggpubr)
```

```{r import tables}
df_phylum <- read_excel("C:/Users/amapo/Documents/GitHub/microbiome_soil/sequences_processing/16S/16S_results/16S_phylum_reads.xlsx")
df_order <- read_excel("C:/Users/amapo/Documents/GitHub/microbiome_soil/sequences_processing/16S/16S_results/16S_order_reads.xlsx")
df_family <- read_excel("C:/Users/amapo/Documents/GitHub/microbiome_soil/sequences_processing/16S/16S_results/16S_family_reads.xlsx")
df_gender <- read_excel("C:/Users/amapo/Documents/GitHub/microbiome_soil/sequences_processing/16S/16S_results/16S_gender_reads.xlsx")

# Import the S1 table

S1_table <- read_excel("C:/Users/amapo/Documents/GitHub/microbiome_soil/sequences_processing/ITS2_CLC/S1_table.xlsx")
View(S1_table)

# Change format to .csv

write.csv(S1_table, file = "S1_table.csv", row.names = TRUE)

#Delete the same samples as 16S

S1_table <- S1_table[-c( 4, 11), ]
```

```{r phylum}
# Phylum of 16S 


# Shannon for Phylum of 16S

shannon_phylum_16S <- ddply(df_phylum,~Samples,function(x) {
  data.frame(SHANNON=diversity(x[-1], index = "shannon"))
})
write.csv(shannon_phylum_16S, file = "shannon_phylum_16S.csv", row.names = TRUE)


# Simpson for Phylum of 16S

simpson_phylum_16S <- ddply(df_phylum,~Samples,function(x) {
  data.frame(SIMPSON=diversity(x[-1], index = "simpson"))
})
write.csv(simpson_phylum_16S, file = "simpson_phylum_16S.csv", row.names = TRUE)


# Chao1 for Phylum of 16S



# Merge biodiversity indexes

bi_phylum_16S <- merge(shannon_phylum_16S, simpson_phylum_16S, by = "Samples")


# Export the merged table in excel and .csv

write.xlsx(bi_phylum_16S,"bi_phylum_16S.xlsx")
write.csv(bi_phylum_16S, file = "bi_phylum_16S.csv", row.names = TRUE)


# Preparation of data for Spearman correlation

#Merge bi and S1 tables
data_phylum_16S <- merge(bi_phylum_16S, S1_table, by = "Samples")


# Spearman correlation for SHANNON

corr_phy_16S_shann <- cor.test(x=data_phylum_16S$`ECe _values`, y=data_phylum_16S$SHANNON, method = "spearman")

#Cannot compute exact p-value with ties

corr_phy_16S_shann

# Manually calculating

phy.ranked.shann <- data.frame(cbind(rank(data_phylum_16S$`ECe _values`, ties.method = "average"), rank(data_phylum_16S$SHANNON, ties.method = "average")))

colnames(phy.ranked.shann) <- c("ECe_values", "SHANNON")

rho <- cov(phy.ranked.shann) / (sd(phy.ranked.shann$ECe_values) * sd(phy.ranked.shann$SHANNON))

rho[[2]]

corr_phy_16S_shann$estimate

corr_phy_16S_shann$statistic

corr_phy_16S_shann$p.value


# Spearman correlation for SIMPSON

corr_phy_16S_sim <- cor.test(x=data_phylum_16S$`ECe _values`, y=data_phylum_16S$SIMPSON, method = "spearman")

#Cannot compute exact p-value with ties

corr_phy_16S_sim

# Manually calculating

phy.ranked.sim <- data.frame(cbind(rank(data_phylum_16S$`ECe _values`, ties.method = "average"), rank(data_phylum_16S$SIMPSON, ties.method = "average")))

colnames(phy.ranked.sim) <- c("ECe_values", "SIMPSON")

rho <- cov(phy.ranked.sim) / (sd(phy.ranked.sim$ECe_values) * sd(phy.ranked.sim$SIMPSON))

rho[[2]]

corr_phy_16S_sim$estimate

corr_phy_16S_sim$statistic

corr_phy_16S_sim$p.value
```

```{r order}
# Order of 16S

# Shannon for Order of 16S

shannon_order_16S <- ddply(df_order,~Samples,function(x) {
  data.frame(SHANNON=diversity(x[-1], index = "shannon"))
})
write.csv(shannon_order_16S, file = "shannon_order_16S.csv", row.names = TRUE)

# Simpson for Order of 16S

simpson_order_16S <- ddply(df_order,~Samples,function(x) {
  data.frame(SIMPSON=diversity(x[-1], index = "simpson"))
})
write.csv(simpson_order_16S, file = "simpson_order_16S.csv", row.names = TRUE)

# Chao1 for Order of 16S



# Merge biodiversity indexes

bi_order_16S <- merge(shannon_order_16S, simpson_order_16S, by = "Samples")


# Export the merged table in excel and .csv

write.xlsx(bi_order_16S,"bi_order_16S.xlsx")
write.csv(bi_order_16S, file = "bi_order_16S.csv", row.names = TRUE)


# Preparation of data for Spearman correlation

#Merge bi and S1 tables
data_order_16S <- merge(bi_order_16S, S1_table, by = "Samples")


# Spearman correlation for SHANNON

corr_order_16S_shann <- cor.test(x=data_order_16S$`ECe _values`, y=data_order_16S$SHANNON, method = "spearman")

#Cannot compute exact p-value with ties

corr_order_16S_shann

# Manually calculating

order.ranked.shann <- data.frame(cbind(rank(data_order_16S$`ECe _values`, ties.method = "average"), rank(data_order_16S$SHANNON, ties.method = "average")))

colnames(order.ranked.shann) <- c("ECe_values", "SHANNON")

rho <- cov(order.ranked.shann) / (sd(order.ranked.shann$ECe_values) * sd(order.ranked.shann$SHANNON))

rho[[2]]

corr_order_16S_shann$estimate

corr_order_16S_shann$statistic

corr_order_16S_shann$p.value


# Spearman correlation for SIMPSON

corr_order_16S_sim <- cor.test(x=data_order_16S$`ECe _values`, y=data_order_16S$SIMPSON, method = "spearman")

#Cannot compute exact p-value with ties

corr_order_16S_sim

# Manually calculating

order.ranked.sim <- data.frame(cbind(rank(data_order_16S$`ECe _values`, ties.method = "average"), rank(data_order_16S$SIMPSON, ties.method = "average")))

colnames(order.ranked.sim) <- c("ECe_values", "SIMPSON")

rho <- cov(order.ranked.sim) / (sd(order.ranked.sim$ECe_values) * sd(order.ranked.sim$SIMPSON))

rho[[2]]

corr_order_16S_sim$estimate

corr_order_16S_sim$statistic

corr_order_16S_sim$p.value
```

```{r family}
# Family of 16S

# Shannon for Family of 16S

shannon_family_16S <- ddply(df_family,~Samples,function(x) {
  data.frame(SHANNON=diversity(x[-1], index = "shannon"))
})
write.csv(shannon_family_16S, file = "shannon_family_16S.csv", row.names = TRUE)

# Simpson for Family of 16S

simpson_family_16S <- ddply(df_family,~Samples,function(x) {
  data.frame(SIMPSON=diversity(x[-1], index = "simpson"))
})
write.csv(simpson_family_16S, file = "simpson_family_16S.csv", row.names = TRUE)

# Chao1 for Family of 16S



# Merge biodiversity indexes

bi_family_16S <- merge(shannon_family_16S, simpson_family_16S, by = "Samples")


# Export the merged table in excel and .csv

write.xlsx(bi_family_16S,"bi_family_16S.xlsx")
write.csv(bi_family_16S, file = "bi_family_16S.csv", row.names = TRUE)


# Preparation of data for Spearman correlation

#Merge bi and S1 tables
data_family_16S <- merge(bi_family_16S, S1_table, by = "Samples")


# Spearman correlation for SHANNON

corr_family_16S_shann <- cor.test(x=data_family_16S$`ECe _values`, y=data_family_16S$SHANNON, method = "spearman")

#Cannot compute exact p-value with ties

corr_family_16S_shann

# Manually calculating

family.ranked.shann <- data.frame(cbind(rank(data_family_16S$`ECe _values`, ties.method = "average"), rank(data_family_16S$SHANNON, ties.method = "average")))

colnames(family.ranked.shann) <- c("ECe_values", "SHANNON")

rho <- cov(family.ranked.shann) / (sd(family.ranked.shann$ECe_values) * sd(family.ranked.shann$SHANNON))

rho[[2]]

corr_family_16S_shann$estimate

corr_family_16S_shann$statistic

corr_family_16S_shann$p.value


# Spearman correlation for SIMPSON

corr_family_16S_sim <- cor.test(x=data_family_16S$`ECe _values`, y=data_family_16S$SIMPSON, method = "spearman")

#Cannot compute exact p-value with ties

corr_family_16S_sim

# Manually calculating

family.ranked.sim <- data.frame(cbind(rank(data_family_16S$`ECe _values`, ties.method = "average"), rank(data_family_16S$SIMPSON, ties.method = "average")))

colnames(family.ranked.sim) <- c("ECe_values", "SIMPSON")

rho <- cov(family.ranked.sim) / (sd(family.ranked.sim$ECe_values) * sd(family.ranked.sim$SIMPSON))

rho[[2]]

corr_family_16S_sim$estimate

corr_family_16S_sim$statistic

corr_family_16S_sim$p.value
```

```{r gender}
# Gender of 16S

# Shannon for Gender of 16S

shannon_gender_16S <- ddply(df_gender,~Samples,function(x) {
  data.frame(SHANNON=diversity(x[-1], index = "shannon"))
})
write.csv(shannon_gender_16S, file = "shannon_gender_16S.csv", row.names = TRUE)

# Simpson for Gender of 16S

simpson_gender_16S <- ddply(df_gender,~Samples,function(x) {
  data.frame(SIMPSON=diversity(x[-1], index = "simpson"))
})
write.csv(simpson_gender_16S, file = "simpson_gender_16S.csv", row.names = TRUE)

# Chao1 for Gender of 16S




# Merge biodiversity indexes

bi_gender_16S <- merge(shannon_gender_16S, simpson_gender_16S, by = "Samples")


# Export the merged table in excel and .csv

write.xlsx(bi_gender_16S,"bi_gender_16S.xlsx")
write.csv(bi_gender_16S, file = "bi_gender_16S.csv", row.names = TRUE)


# Preparation of data for Spearman correlation

#Merge bi and S1 tables
data_gender_16S <- merge(bi_gender_16S, S1_table, by = "Samples")


# Spearman correlation for SHANNON

corr_gender_16S_shann <- cor.test(x=data_gender_16S$`ECe _values`, y=data_gender_16S$SHANNON, method = "spearman")

#Cannot compute exact p-value with ties

corr_gender_16S_shann

# Manually calculating

gender.ranked.shann <- data.frame(cbind(rank(data_gender_16S$`ECe _values`, ties.method = "average"), rank(data_gender_16S$SHANNON, ties.method = "average")))

colnames(gender.ranked.shann) <- c("ECe_values", "SHANNON")

rho <- cov(gender.ranked.shann) / (sd(gender.ranked.shann$ECe_values) * sd(gender.ranked.shann$SHANNON))

rho[[2]]

corr_gender_16S_shann$estimate

corr_gender_16S_shann$statistic

corr_gender_16S_shann$p.value


# Spearman correlation for SIMPSON

corr_gender_16S_sim <- cor.test(x=data_gender_16S$`ECe _values`, y=data_gender_16S$SIMPSON, method = "spearman")

#Cannot compute exact p-value with ties

corr_gender_16S_sim

# Manually calculating

gender.ranked.sim <- data.frame(cbind(rank(data_gender_16S$`ECe _values`, ties.method = "average"), rank(data_gender_16S$SIMPSON, ties.method = "average")))

colnames(gender.ranked.sim) <- c("ECe_values", "SIMPSON")

rho <- cov(gender.ranked.sim) / (sd(gender.ranked.sim$ECe_values) * sd(gender.ranked.sim$SIMPSON))

rho[[2]]

corr_gender_16S_sim$estimate

corr_gender_16S_sim$statistic

corr_gender_16S_sim$p.value
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
